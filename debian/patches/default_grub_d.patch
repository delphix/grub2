From 599a71ef532c7f576fc72af2bdd9f5e95d6a0893 Mon Sep 17 00:00:00 2001
From: Colin Watson <cjwatson@ubuntu.com>
Date: Mon, 13 Jan 2014 12:13:10 +0000
Subject: Read /etc/default/grub.d/*.cfg after /etc/default/grub

Bug-Ubuntu: https://bugs.launchpad.net/bugs/901600
Forwarded: no
Last-Update: 2013-12-25

Patch-Name: default_grub_d.patch
---
 grub-core/osdep/unix/config.c | 62 ++++++++++++++++++++++++++++++++-----------
 util/grub-mkconfig.in         |  5 ++++
 2 files changed, 52 insertions(+), 15 deletions(-)

diff --git a/grub-core/osdep/unix/config.c b/grub-core/osdep/unix/config.c
index f4b0bb4..c966477 100644
--- a/grub-core/osdep/unix/config.c
+++ b/grub-core/osdep/unix/config.c
@@ -61,28 +61,16 @@ grub_util_get_localedir (void)
   return LOCALEDIR;
 }
 
-void
-grub_util_load_config (struct grub_util_config *cfg)
+static void
+grub_util_load_one_config (struct grub_util_config *cfg, const char *cfgfile)
 {
   pid_t pid;
   const char *argv[4];
   char *script, *ptr;
-  const char *cfgfile, *iptr;
+  const char *iptr;
   FILE *f = NULL;
   int fd;
-  const char *v;
 
-  memset (cfg, 0, sizeof (*cfg));
-
-  v = getenv ("GRUB_ENABLE_CRYPTODISK");
-  if (v && v[0] == 'y' && v[1] == '\0')
-    cfg->is_cryptodisk_enabled = 1;
-
-  v = getenv ("GRUB_DISTRIBUTOR");
-  if (v)
-    cfg->grub_distributor = xstrdup (v);
-
-  cfgfile = grub_util_get_config_filename ();
   if (!grub_util_is_regular (cfgfile))
     return;
 
@@ -137,3 +125,47 @@ grub_util_load_config (struct grub_util_config *cfg)
     grub_util_warn (_("cannot open configuration file `%s': %s"),
 		    cfgfile, strerror (errno));
 }
+
+void
+grub_util_load_config (struct grub_util_config *cfg)
+{
+  const char *cfgfile;
+  const char *v;
+  char *cfgdir;
+  grub_util_fd_dir_t d;
+
+  memset (cfg, 0, sizeof (*cfg));
+
+  v = getenv ("GRUB_ENABLE_CRYPTODISK");
+  if (v && v[0] == 'y' && v[1] == '\0')
+    cfg->is_cryptodisk_enabled = 1;
+
+  v = getenv ("GRUB_DISTRIBUTOR");
+  if (v)
+    cfg->grub_distributor = xstrdup (v);
+
+  cfgfile = grub_util_get_config_filename ();
+
+  grub_util_load_one_config (cfg, cfgfile);
+
+  cfgdir = xasprintf ("%s.d", cfgfile);
+  d = grub_util_fd_opendir (cfgdir);
+  if (d)
+    {
+      grub_util_fd_dirent_t de;
+
+      while ((de = grub_util_fd_readdir (d)))
+	{
+	  const char *ext = strrchr (de->d_name, '.');
+	  char *x;
+
+	  if (!ext || strcmp (ext, ".cfg") != 0)
+	    continue;
+
+	  x = grub_util_path_concat (2, cfgdir, de->d_name);
+	  grub_util_load_one_config (cfg, x);
+	  free (x);
+	}
+      grub_util_fd_closedir (d);
+    }
+}
diff --git a/util/grub-mkconfig.in b/util/grub-mkconfig.in
index 81a9afd..62780bf 100644
--- a/util/grub-mkconfig.in
+++ b/util/grub-mkconfig.in
@@ -154,6 +154,11 @@ fi
 if test -f ${sysconfdir}/default/grub ; then
   . ${sysconfdir}/default/grub
 fi
+for x in ${sysconfdir}/default/grub.d/*.cfg ; do
+  if [ -e "${x}" ]; then
+    . "${x}"
+  fi
+done
 
 # XXX: should this be deprecated at some point?
 if [ "x${GRUB_TERMINAL}" != "x" ] ; then
