Description: Fall back to i386-pc if booted using EFI but -efi is missing
 It may be possible, particularly in recovery situations, to be booted using
 EFI on x86 when only the i386-pc target is installed.  There's nothing
 actually stopping us installing i386-pc from an EFI environment, and it's
 better than returning a confusing error.
Author: Colin Watson <cjwatson@ubuntu.com>
Forwarded: no
Last-Update: 2013-11-19

Index: b/grub-core/osdep/linux/platform.c
===================================================================
--- a/grub-core/osdep/linux/platform.c
+++ b/grub-core/osdep/linux/platform.c
@@ -19,9 +19,11 @@
 #include <config.h>
 
 #include <grub/util/install.h>
+#include <grub/emu/config.h>
 #include <grub/emu/exec.h>
 #include <sys/types.h>
 #include <dirent.h>
+#include <stdlib.h>
 #include <string.h>
 
 #include <sys/utsname.h>
@@ -73,12 +75,24 @@
 	"efivars", NULL });
   if (is_not_empty_directory ("/sys/firmware/efi"))
     {
+      const char *pkglibdir = grub_util_get_pkglibdir ();
+      const char *platform;
+      char *pd;
+      int found;
+
       if (is_64_kernel ())
-	return "x86_64-efi";
+	platform = "x86_64-efi";
       else
-	return "i386-efi";
+	platform = "i386-efi";
+
+      pd = grub_util_path_concat (2, pkglibdir, platform);
+      found = grub_util_is_directory (pd);
+      free (pd);
+      if (found)
+	return platform;
     }
-  else if (is_not_empty_directory ("/proc/device-tree"))
+
+  if (is_not_empty_directory ("/proc/device-tree"))
     return "i386-ieee1275";
   else
     return "i386-pc";
